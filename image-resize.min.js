import defaultsDeep from"lodash/defaultsDeep";import DefaultOptions from"./src/DefaultOptions";import{DisplaySize}from"./src/modules/DisplaySize";import{Toolbar}from"./src/modules/Toolbar";import{Resize}from"./src/modules/Resize";const knownModules={DisplaySize:DisplaySize,Toolbar:Toolbar,Resize:Resize};export default class ImageResize{constructor(e,t={}){this.quill=e;let i=!1;t.modules&&(i=t.modules.slice()),t.parchment&&(this.parchment=t.parchment),this.options=defaultsDeep({},t,DefaultOptions),!1!==i&&(this.options.modules=i),document.execCommand("enableObjectResizing",!1,"false"),this.quill.root.addEventListener("click",this.handleClick,!1),this.quill.root.parentNode.style.position=this.quill.root.parentNode.style.position||"relative",this.moduleClasses=this.options.modules,this.modules=[]}initializeModules=()=>{this.removeModules(),this.modules=this.moduleClasses.map((e=>new(knownModules[e]||e)(this))),this.modules.forEach((e=>{e.onCreate(this.parchment)})),this.onUpdate()};onUpdate=()=>{this.repositionElements(),this.modules.forEach((e=>{e.onUpdate()}))};removeModules=()=>{this.modules.forEach((e=>{e.onDestroy()})),this.modules=[]};handleClick=e=>{if(e.target&&e.target.tagName&&"IMG"===e.target.tagName.toUpperCase()){if(this.img===e.target)return;this.img&&this.hide(),this.show(e.target)}else this.img&&this.hide()};show=e=>{this.img=e,this.showOverlay(),this.initializeModules()};showOverlay=()=>{this.overlay&&this.hideOverlay(),this.quill.setSelection(null),this.setUserSelect("none"),document.addEventListener("keyup",this.checkImage,!0),this.quill.root.addEventListener("input",this.checkImage,!0),this.overlay=document.createElement("div"),Object.assign(this.overlay.style,this.options.overlayStyles),this.quill.root.parentNode.appendChild(this.overlay),this.repositionElements()};hideOverlay=()=>{this.overlay&&(this.quill.root.parentNode.removeChild(this.overlay),this.overlay=void 0,document.removeEventListener("keyup",this.checkImage),this.quill.root.removeEventListener("input",this.checkImage),this.setUserSelect(""))};repositionElements=()=>{if(!this.overlay||!this.img)return;const e=this.quill.root.parentNode,t=this.img.getBoundingClientRect(),i=e.getBoundingClientRect();Object.assign(this.overlay.style,{left:`${t.left-i.left-1+e.scrollLeft}px`,top:`${t.top-i.top+e.scrollTop}px`,width:`${t.width}px`,height:`${t.height}px`})};hide=()=>{this.hideOverlay(),this.removeModules(),this.img=void 0};setUserSelect=e=>{["userSelect","mozUserSelect","webkitUserSelect","msUserSelect"].forEach((t=>{this.quill.root.style[t]=e,document.documentElement.style[t]=e}))};checkImage=e=>{if(this.img){if(46==e.keyCode||8==e.keyCode)try{window.Quill.find(this.img).deleteAt(0)}catch(e){}this.hide()}}}window.Quill&&window.Quill.register("modules/imageResize",ImageResize);