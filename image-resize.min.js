import defaultsDeep from"lodash/defaultsDeep";import DefaultOptions from"./DefaultOptions";import{DisplaySize}from"./modules/DisplaySize";import{Toolbar}from"./modules/Toolbar";import{Resize}from"./modules/Resize";const knownModules={DisplaySize:DisplaySize,Toolbar:Toolbar,Resize:Resize};export default class ImageResize{constructor(quill,options={}){this.quill=quill;let moduleClasses=false;if(options.modules){moduleClasses=options.modules.slice()}if(options.parchment){this.parchment=options.parchment}this.options=defaultsDeep({},options,DefaultOptions);if(moduleClasses!==false){this.options.modules=moduleClasses}document.execCommand("enableObjectResizing",false,"false");this.quill.root.addEventListener("click",this.handleClick,false);this.quill.root.parentNode.style.position=this.quill.root.parentNode.style.position||"relative";this.moduleClasses=this.options.modules;this.modules=[]}initializeModules=()=>{this.removeModules();this.modules=this.moduleClasses.map((ModuleClass=>new(knownModules[ModuleClass]||ModuleClass)(this)));this.modules.forEach((module=>{module.onCreate(this.parchment)}));this.onUpdate()};onUpdate=()=>{this.repositionElements();this.modules.forEach((module=>{module.onUpdate()}))};removeModules=()=>{this.modules.forEach((module=>{module.onDestroy()}));this.modules=[]};handleClick=evt=>{if(evt.target&&evt.target.tagName&&evt.target.tagName.toUpperCase()==="IMG"){if(this.img===evt.target){return}if(this.img){this.hide()}this.show(evt.target)}else if(this.img){this.hide()}};show=img=>{this.img=img;this.showOverlay();this.initializeModules()};showOverlay=()=>{if(this.overlay){this.hideOverlay()}this.quill.setSelection(null);this.setUserSelect("none");document.addEventListener("keyup",this.checkImage,true);this.quill.root.addEventListener("input",this.checkImage,true);this.overlay=document.createElement("div");Object.assign(this.overlay.style,this.options.overlayStyles);this.quill.root.parentNode.appendChild(this.overlay);this.repositionElements()};hideOverlay=()=>{if(!this.overlay){return}this.quill.root.parentNode.removeChild(this.overlay);this.overlay=undefined;document.removeEventListener("keyup",this.checkImage);this.quill.root.removeEventListener("input",this.checkImage);this.setUserSelect("")};repositionElements=()=>{if(!this.overlay||!this.img){return}const parent=this.quill.root.parentNode;const imgRect=this.img.getBoundingClientRect();const containerRect=parent.getBoundingClientRect();Object.assign(this.overlay.style,{left:`${imgRect.left-containerRect.left-1+parent.scrollLeft}px`,top:`${imgRect.top-containerRect.top+parent.scrollTop}px`,width:`${imgRect.width}px`,height:`${imgRect.height}px`})};hide=()=>{this.hideOverlay();this.removeModules();this.img=undefined};setUserSelect=value=>{["userSelect","mozUserSelect","webkitUserSelect","msUserSelect"].forEach((prop=>{this.quill.root.style[prop]=value;document.documentElement.style[prop]=value}))};checkImage=evt=>{if(this.img){if(evt.keyCode==46||evt.keyCode==8){try{window.Quill.find(this.img).deleteAt(0)}catch(e){}}this.hide()}}}if(window.Quill){window.Quill.register("modules/imageResize",ImageResize)}export default{modules:["DisplaySize","Toolbar","Resize"],overlayStyles:{position:"absolute",boxSizing:"border-box",border:"1px dashed #444"},handleStyles:{position:"absolute",height:"12px",width:"12px",backgroundColor:"white",border:"1px solid #777",boxSizing:"border-box",opacity:"0.80"},displayStyles:{position:"absolute",font:"12px/1.0 Arial, Helvetica, sans-serif",padding:"4px 8px",textAlign:"center",backgroundColor:"white",color:"#333",border:"1px solid #777",boxSizing:"border-box",opacity:"0.80",cursor:"default"},toolbarStyles:{position:"absolute",top:"-12px",right:"0",left:"0",height:"0",minWidth:"100px",font:"12px/1.0 Arial, Helvetica, sans-serif",textAlign:"center",color:"#333",boxSizing:"border-box",cursor:"default"},toolbarButtonStyles:{display:"inline-block",width:"24px",height:"24px",background:"white",border:"1px solid #999",verticalAlign:"middle"},toolbarButtonSvgStyles:{fill:"#444",stroke:"#444",strokeWidth:"2"}};import IconAlignLeft from"quill/assets/icons/align-left.svg";import IconAlignCenter from"quill/assets/icons/align-center.svg";import IconAlignRight from"quill/assets/icons/align-right.svg";import{BaseModule}from"./BaseModule";let Parchment={};let FloatStyle={};let MarginStyle={};let DisplayStyle={};export class Toolbar extends BaseModule{onCreate=parchment=>{Parchment=parchment;FloatStyle=new Parchment.Attributor.Style("float","float");MarginStyle=new Parchment.Attributor.Style("margin","margin");DisplayStyle=new Parchment.Attributor.Style("display","display");this.toolbar=document.createElement("div");Object.assign(this.toolbar.style,this.options.toolbarStyles);this.overlay.appendChild(this.toolbar);this._defineAlignments();this._addToolbarButtons()};onDestroy=()=>{};onUpdate=()=>{};_defineAlignments=()=>{this.alignments=[{icon:IconAlignLeft,apply:()=>{DisplayStyle.add(this.img,"inline");FloatStyle.add(this.img,"left");MarginStyle.add(this.img,"0 1em 1em 0")},isApplied:()=>FloatStyle.value(this.img)=="left"},{icon:IconAlignCenter,apply:()=>{DisplayStyle.add(this.img,"block");FloatStyle.remove(this.img);MarginStyle.add(this.img,"auto")},isApplied:()=>MarginStyle.value(this.img)=="auto"},{icon:IconAlignRight,apply:()=>{DisplayStyle.add(this.img,"inline");FloatStyle.add(this.img,"right");MarginStyle.add(this.img,"0 0 1em 1em")},isApplied:()=>FloatStyle.value(this.img)=="right"}]};_addToolbarButtons=()=>{const buttons=[];this.alignments.forEach(((alignment,idx)=>{const button=document.createElement("span");buttons.push(button);button.innerHTML=alignment.icon;button.addEventListener("click",(()=>{buttons.forEach((button=>button.style.filter=""));if(alignment.isApplied()){FloatStyle.remove(this.img);MarginStyle.remove(this.img);DisplayStyle.remove(this.img)}else{this._selectButton(button);alignment.apply()}this.requestUpdate()}));Object.assign(button.style,this.options.toolbarButtonStyles);if(idx>0){button.style.borderLeftWidth="0"}Object.assign(button.children[0].style,this.options.toolbarButtonSvgStyles);if(alignment.isApplied()){this._selectButton(button)}this.toolbar.appendChild(button)}))};_selectButton=button=>{button.style.filter="invert(20%)"}}import{BaseModule}from"./BaseModule";export class Resize extends BaseModule{onCreate=()=>{this.boxes=[];this.addBox("nwse-resize");this.addBox("nesw-resize");this.addBox("nwse-resize");this.addBox("nesw-resize");this.positionBoxes()};onDestroy=()=>{this.setCursor("")};positionBoxes=()=>{const handleXOffset=`${-parseFloat(this.options.handleStyles.width)/2}px`;const handleYOffset=`${-parseFloat(this.options.handleStyles.height)/2}px`;[{left:handleXOffset,top:handleYOffset},{right:handleXOffset,top:handleYOffset},{right:handleXOffset,bottom:handleYOffset},{left:handleXOffset,bottom:handleYOffset}].forEach(((pos,idx)=>{Object.assign(this.boxes[idx].style,pos)}))};addBox=cursor=>{const box=document.createElement("div");Object.assign(box.style,this.options.handleStyles);box.style.cursor=cursor;box.style.width=`${this.options.handleStyles.width}px`;box.style.height=`${this.options.handleStyles.height}px`;box.addEventListener("mousedown",this.handleMousedown,false);this.overlay.appendChild(box);this.boxes.push(box)};handleMousedown=evt=>{this.dragBox=evt.target;this.dragStartX=evt.clientX;this.preDragWidth=this.img.width||this.img.naturalWidth;this.setCursor(this.dragBox.style.cursor);document.addEventListener("mousemove",this.handleDrag,false);document.addEventListener("mouseup",this.handleMouseup,false)};handleMouseup=()=>{this.setCursor("");document.removeEventListener("mousemove",this.handleDrag);document.removeEventListener("mouseup",this.handleMouseup)};handleDrag=evt=>{if(!this.img){return}const deltaX=evt.clientX-this.dragStartX;if(this.dragBox===this.boxes[0]||this.dragBox===this.boxes[3]){this.img.width=Math.round(this.preDragWidth-deltaX)}else{this.img.width=Math.round(this.preDragWidth+deltaX)}this.requestUpdate()};setCursor=value=>{[document.body,this.img].forEach((el=>{el.style.cursor=value}))}}import{BaseModule}from"./BaseModule";export class DisplaySize extends BaseModule{onCreate=()=>{this.display=document.createElement("div");Object.assign(this.display.style,this.options.displayStyles);this.overlay.appendChild(this.display)};onDestroy=()=>{};onUpdate=()=>{if(!this.display||!this.img){return}const size=this.getCurrentSize();this.display.innerHTML=size.join(" &times; ");if(size[0]>120&&size[1]>30){Object.assign(this.display.style,{right:"4px",bottom:"4px",left:"auto"})}else if(this.img.style.float=="right"){const dispRect=this.display.getBoundingClientRect();Object.assign(this.display.style,{right:"auto",bottom:`-${dispRect.height+4}px`,left:`-${dispRect.width+4}px`})}else{const dispRect=this.display.getBoundingClientRect();Object.assign(this.display.style,{right:`-${dispRect.width+4}px`,bottom:`-${dispRect.height+4}px`,left:"auto"})}};getCurrentSize=()=>[this.img.width,Math.round(this.img.width/this.img.naturalWidth*this.img.naturalHeight)]}export class BaseModule{constructor(resizer){this.overlay=resizer.overlay;this.img=resizer.img;this.options=resizer.options;this.requestUpdate=resizer.onUpdate}onCreate=()=>{};onDestroy=()=>{};onUpdate=()=>{}}